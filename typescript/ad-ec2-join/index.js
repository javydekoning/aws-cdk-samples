"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/core");
const ec2 = require("@aws-cdk/aws-ec2");
const ad = require("@aws-cdk/aws-directoryservice");
const sm = require("@aws-cdk/aws-secretsmanager");
const ssm = require("@aws-cdk/aws-ssm");
const iam = require("@aws-cdk/aws-iam");
class AdFsxStack extends cdk.Stack {
    constructor(app, id, adDnsDomainName) {
        super(app, id);
        const vpc = new ec2.Vpc(this, 'VPC', {});
        const privateSubnets = vpc.privateSubnets.slice(0, 2).map(x => x.subnetId);
        //Generate AD admin password and store in Secrets Manager
        const templatedSecret = new sm.Secret(this, adDnsDomainName + '_credentials', {
            generateSecretString: {
                secretStringTemplate: JSON.stringify({ username: 'admin' }),
                generateStringKey: 'password'
            },
        });
        //Create Active Directory
        const mad = new ad.CfnMicrosoftAD(this, 'ad', {
            name: adDnsDomainName,
            password: templatedSecret.secretValueFromJson('password').toString(),
            vpcSettings: {
                vpcId: vpc.vpcId,
                subnetIds: privateSubnets
            }
        });
        //Set VPC DHCP options for AD
        const dhcpOptions = new ec2.CfnDHCPOptions(this, 'dhcpOptions', {
            domainName: adDnsDomainName,
            domainNameServers: mad.attrDnsIpAddresses,
        });
        new ec2.CfnVPCDHCPOptionsAssociation(this, 'dhcpOptionsAssoc', {
            dhcpOptionsId: dhcpOptions.ref,
            vpcId: vpc.vpcId
        });
        //User data to add 'Active Directory Users and Computers mgmt tool to EC2 instance'
        const ud = ec2.UserData.forWindows();
        ud.addCommands('Add-WindowsFeature RSAT-Role-Tools');
        //EC2 instance, in public subnet so we can RDP to the instance
        const instance = new ec2.Instance(this, 'ad-joined-instance', {
            instanceType: ec2.InstanceType.of(ec2.InstanceClass.C5, ec2.InstanceSize.LARGE),
            vpc,
            machineImage: new ec2.WindowsImage(ec2.WindowsVersion.WINDOWS_SERVER_2019_ENGLISH_FULL_BASE),
            vpcSubnets: { subnetType: ec2.SubnetType.PUBLIC },
            userData: ud
        });
        //Add roles to instance profile for Domain Join via SSM
        const policies = ['AmazonSSMManagedInstanceCore', 'AmazonSSMDirectoryServiceAccess'];
        policies.forEach((x) => instance.role.addManagedPolicy(iam.ManagedPolicy.fromAwsManagedPolicyName(x)));
        //SSM Document
        const docContent = `{
      "schemaVersion": "1.0",
      "description": "Join an instance to a domain",
      "runtimeConfig": {
        "aws:domainJoin": {
          "properties": {
            "directoryId": "${mad.attrAlias}",
            "directoryName": "${adDnsDomainName}",
            "dnsIpAddresses": [
              "${cdk.Fn.select(0, mad.attrDnsIpAddresses)}",
              "${cdk.Fn.select(1, mad.attrDnsIpAddresses)}"
            ]
          }
        }
      }
    }`;
        const ssmDoc = new ssm.CfnDocument(this, 'domainJoinDoc', {
            content: docContent,
            name: 'ad-join-domain',
        });
        new ssm.CfnAssociation(this, 'ssmAssociation', {
            name: ssmDoc.ref,
            instanceId: instance.instanceId
        });
        const outputs = [
            { "name": "directoryAlias", "value": mad.attrAlias },
            { "name": "directoryDns", "value": cdk.Fn.join(',', mad.attrDnsIpAddresses) },
            { "name": "subnetIds", "value": cdk.Fn.join(',', privateSubnets) },
            { "name": "vpcId", "value": vpc.vpcId }
        ];
        outputs.forEach((x) => {
            if (x.value) {
                new cdk.CfnOutput(this, x.name, { value: x.value });
            }
        });
    }
}
const app = new cdk.App();
new AdFsxStack(app, 'AdFsxStack', 'example.corp');
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUFxQztBQUNyQyx3Q0FBd0M7QUFDeEMsb0RBQW9EO0FBQ3BELGtEQUFrRDtBQUNsRCx3Q0FBd0M7QUFDeEMsd0NBQXdDO0FBRXhDLE1BQU0sVUFBVyxTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBQ2hDLFlBQVksR0FBWSxFQUFFLEVBQVUsRUFBRSxlQUF1QjtRQUMzRCxLQUFLLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWYsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUV6RSx5REFBeUQ7UUFDekQsTUFBTSxlQUFlLEdBQUcsSUFBSSxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxlQUFlLEdBQUcsY0FBYyxFQUFFO1lBQzVFLG9CQUFvQixFQUFFO2dCQUNwQixvQkFBb0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxDQUFDO2dCQUMzRCxpQkFBaUIsRUFBRSxVQUFVO2FBQzlCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgseUJBQXlCO1FBQ3pCLE1BQU0sR0FBRyxHQUFHLElBQUksRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzVDLElBQUksRUFBRSxlQUFlO1lBQ3JCLFFBQVEsRUFBRSxlQUFlLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ3BFLFdBQVcsRUFBRTtnQkFD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WUFDOUQsRUFBQyxNQUFNLEVBQUMsT0FBTyxFQUFFLE9BQU8sRUFBQyxHQUFHLENBQUMsS0FBSyxFQUFDO1NBQ3BDLENBQUE7UUFFRCxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDcEIsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFO2dCQUNYLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsS0FBSyxFQUFDLENBQUMsQ0FBQTthQUNsRDtRQUNILENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUNGO0FBRUQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDMUIsSUFBSSxVQUFVLENBQUMsR0FBRyxFQUFFLFlBQVksRUFBRSxjQUFjLENBQUMsQ0FBQztBQUNsRCxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBhZCBmcm9tICdAYXdzLWNkay9hd3MtZGlyZWN0b3J5c2VydmljZSc7XG5pbXBvcnQgKiBhcyBzbSBmcm9tICdAYXdzLWNkay9hd3Mtc2VjcmV0c21hbmFnZXInO1xuaW1wb3J0ICogYXMgc3NtIGZyb20gJ0Bhd3MtY2RrL2F3cy1zc20nO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ0Bhd3MtY2RrL2F3cy1pYW0nO1xuXG5jbGFzcyBBZEZzeFN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgY29uc3RydWN0b3IoYXBwOiBjZGsuQXBwLCBpZDogc3RyaW5nLCBhZERuc0RvbWFpbk5hbWU6IHN0cmluZykge1xuICAgIHN1cGVyKGFwcCwgaWQpO1xuXG4gICAgY29uc3QgdnBjID0gbmV3IGVjMi5WcGModGhpcywgJ1ZQQycsIHt9KTtcblxuICAgIGNvbnN0IHByaXZhdGVTdWJuZXRzID0gdnBjLnByaXZhdGVTdWJuZXRzLnNsaWNlKDAsMikubWFwKHggPT4geC5zdWJuZXRJZClcblxuICAgIC8vR2VuZXJhdGUgQUQgYWRtaW4gcGFzc3dvcmQgYW5kIHN0b3JlIGluIFNlY3JldHMgTWFuYWdlclxuICAgIGNvbnN0IHRlbXBsYXRlZFNlY3JldCA9IG5ldyBzbS5TZWNyZXQodGhpcywgYWREbnNEb21haW5OYW1lICsgJ19jcmVkZW50aWFscycsIHtcbiAgICAgIGdlbmVyYXRlU2VjcmV0U3RyaW5nOiB7XG4gICAgICAgIHNlY3JldFN0cmluZ1RlbXBsYXRlOiBKU09OLnN0cmluZ2lmeSh7IHVzZXJuYW1lOiAnYWRtaW4nIH0pLFxuICAgICAgICBnZW5lcmF0ZVN0cmluZ0tleTogJ3Bhc3N3b3JkJ1xuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vQ3JlYXRlIEFjdGl2ZSBEaXJlY3RvcnlcbiAgICBjb25zdCBtYWQgPSBuZXcgYWQuQ2ZuTWljcm9zb2Z0QUQodGhpcywgJ2FkJywge1xuICAgICAgbmFtZTogYWREbnNEb21haW5OYW1lLFxuICAgICAgcGFzc3dvcmQ6IHRlbXBsYXRlZFNlY3JldC5zZWNyZXRWYWx1ZUZyb21Kc29uKCdwYXNzd29yZCcpLnRvU3RyaW5nKCksXG4gICAgICB2cGNTZXR0aW5nczoge1xuICAgICAgICB2cGNJZDogdnBjLnZwY0lkLFxuICAgICAgICBzdWJuZXRJZHM6IHByaXZhdGVTdWJuZXRzXG4gICAgICB9XG4gICAgfSlcblxuICAgIC8vU2V0IFZQQyBESENQIG9wdGlvbnMgZm9yIEFEXG4gICAgY29uc3QgZGhjcE9wdGlvbnMgPSBuZXcgZWMyLkNmbkRIQ1BPcHRpb25zKHRoaXMsICdkaGNwT3B0aW9ucycsIHtcbiAgICAgIGRvbWFpbk5hbWU6IGFkRG5zRG9tYWluTmFtZSxcbiAgICAgIGRvbWFpbk5hbWVTZXJ2ZXJzOiBtYWQuYXR0ckRuc0lwQWRkcmVzc2VzLFxuICAgIH0pXG5cbiAgICBuZXcgZWMyLkNmblZQQ0RIQ1BPcHRpb25zQXNzb2NpYXRpb24odGhpcywgJ2RoY3BPcHRpb25zQXNzb2MnLCB7XG4gICAgICBkaGNwT3B0aW9uc0lkOiBkaGNwT3B0aW9ucy5yZWYsXG4gICAgICB2cGNJZDogdnBjLnZwY0lkXG4gICAgfSlcbiAgICBcbiAgICAvL1VzZXIgZGF0YSB0byBhZGQgJ0FjdGl2ZSBEaXJlY3RvcnkgVXNlcnMgYW5kIENvbXB1dGVycyBtZ210IHRvb2wgdG8gRUMyIGluc3RhbmNlJ1xuICAgIGNvbnN0IHVkID0gZWMyLlVzZXJEYXRhLmZvcldpbmRvd3MoKVxuICAgIHVkLmFkZENvbW1hbmRzKCdBZGQtV2luZG93c0ZlYXR1cmUgUlNBVC1Sb2xlLVRvb2xzJylcblxuICAgIC8vRUMyIGluc3RhbmNlLCBpbiBwdWJsaWMgc3VibmV0IHNvIHdlIGNhbiBSRFAgdG8gdGhlIGluc3RhbmNlXG4gICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgZWMyLkluc3RhbmNlKHRoaXMsICdhZC1qb2luZWQtaW5zdGFuY2UnLCB7XG4gICAgICBpbnN0YW5jZVR5cGU6IGVjMi5JbnN0YW5jZVR5cGUub2YoZWMyLkluc3RhbmNlQ2xhc3MuQzUsIGVjMi5JbnN0YW5jZVNpemUuTEFSR0UpLFxuICAgICAgdnBjLFxuICAgICAgbWFjaGluZUltYWdlOiBuZXcgZWMyLldpbmRvd3NJbWFnZShlYzIuV2luZG93c1ZlcnNpb24uV0lORE9XU19TRVJWRVJfMjAxOV9FTkdMSVNIX0ZVTExfQkFTRSksXG4gICAgICB2cGNTdWJuZXRzOiB7c3VibmV0VHlwZTogZWMyLlN1Ym5ldFR5cGUuUFVCTElDfSxcbiAgICAgIHVzZXJEYXRhOiB1ZFxuICAgIH0pXG5cbiAgICAvL0FkZCByb2xlcyB0byBpbnN0YW5jZSBwcm9maWxlIGZvciBEb21haW4gSm9pbiB2aWEgU1NNXG4gICAgY29uc3QgcG9saWNpZXMgPSBbJ0FtYXpvblNTTU1hbmFnZWRJbnN0YW5jZUNvcmUnLCdBbWF6b25TU01EaXJlY3RvcnlTZXJ2aWNlQWNjZXNzJ11cbiAgICBwb2xpY2llcy5mb3JFYWNoKCh4KSA9PiAgaW5zdGFuY2Uucm9sZS5hZGRNYW5hZ2VkUG9saWN5KGlhbS5NYW5hZ2VkUG9saWN5LmZyb21Bd3NNYW5hZ2VkUG9saWN5TmFtZSh4KSkpXG5cbiAgICAvL1NTTSBEb2N1bWVudFxuICAgIGNvbnN0IGRvY0NvbnRlbnQgPSBge1xuICAgICAgXCJzY2hlbWFWZXJzaW9uXCI6IFwiMS4wXCIsXG4gICAgICBcImRlc2NyaXB0aW9uXCI6IFwiSm9pbiBhbiBpbnN0YW5jZSB0byBhIGRvbWFpblwiLFxuICAgICAgXCJydW50aW1lQ29uZmlnXCI6IHtcbiAgICAgICAgXCJhd3M6ZG9tYWluSm9pblwiOiB7XG4gICAgICAgICAgXCJwcm9wZXJ0aWVzXCI6IHtcbiAgICAgICAgICAgIFwiZGlyZWN0b3J5SWRcIjogXCIke21hZC5hdHRyQWxpYXN9XCIsXG4gICAgICAgICAgICBcImRpcmVjdG9yeU5hbWVcIjogXCIke2FkRG5zRG9tYWluTmFtZX1cIixcbiAgICAgICAgICAgIFwiZG5zSXBBZGRyZXNzZXNcIjogW1xuICAgICAgICAgICAgICBcIiR7Y2RrLkZuLnNlbGVjdCgwLCBtYWQuYXR0ckRuc0lwQWRkcmVzc2VzKX1cIixcbiAgICAgICAgICAgICAgXCIke2Nkay5Gbi5zZWxlY3QoMSwgbWFkLmF0dHJEbnNJcEFkZHJlc3Nlcyl9XCJcbiAgICAgICAgICAgIF1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9YFxuXG4gICAgY29uc3Qgc3NtRG9jID0gbmV3IHNzbS5DZm5Eb2N1bWVudCh0aGlzLCAnZG9tYWluSm9pbkRvYycsIHtcbiAgICAgIGNvbnRlbnQ6IGRvY0NvbnRlbnQsXG4gICAgICBuYW1lOiAnYWQtam9pbi1kb21haW4nLFxuXG4gICAgfSlcblxuICAgIG5ldyBzc20uQ2ZuQXNzb2NpYXRpb24odGhpcywgJ3NzbUFzc29jaWF0aW9uJywge1xuICAgICAgbmFtZTogc3NtRG9jLnJlZixcbiAgICAgIGluc3RhbmNlSWQ6IGluc3RhbmNlLmluc3RhbmNlSWRcbiAgICB9KVxuXG4gICAgY29uc3Qgb3V0cHV0cyA9IFtcbiAgICAgIHtcIm5hbWVcIjpcImRpcmVjdG9yeUFsaWFzXCIsXCJ2YWx1ZVwiOm1hZC5hdHRyQWxpYXN9LFxuICAgICAge1wibmFtZVwiOlwiZGlyZWN0b3J5RG5zXCIsXCJ2YWx1ZVwiOmNkay5Gbi5qb2luKCcsJyxtYWQuYXR0ckRuc0lwQWRkcmVzc2VzKX0sXG4gICAgICB7XCJuYW1lXCI6XCJzdWJuZXRJZHNcIiwgXCJ2YWx1ZVwiOiBjZGsuRm4uam9pbignLCcscHJpdmF0ZVN1Ym5ldHMpfSxcbiAgICAgIHtcIm5hbWVcIjpcInZwY0lkXCIsIFwidmFsdWVcIjp2cGMudnBjSWR9XG4gICAgXVxuICAgIFxuICAgIG91dHB1dHMuZm9yRWFjaCgoeCkgPT4geyBcbiAgICAgIGlmICh4LnZhbHVlKSB7XG4gICAgICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsIHgubmFtZSwge3ZhbHVlOiB4LnZhbHVlfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG5cbmNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKCk7XG5uZXcgQWRGc3hTdGFjayhhcHAsICdBZEZzeFN0YWNrJywgJ2V4YW1wbGUuY29ycCcpO1xuYXBwLnN5bnRoKCk7Il19